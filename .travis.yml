language: python

sudo: required
dist: trusty

addons:
  apt:
    packages:
    - cmake
    - curl
    - freeglut3-dev
    - g++
    - g++-aarch64-linux-gnu
    - g++-arm-linux-gnueabihf
    - gperf
    - libbz2-dev
    - libegl1-mesa-dev
    - libfreetype6-dev
    - libgl1-mesa-dri
    - libgles2-mesa-dev
    - libglib2.0-dev
    - libglu1-mesa-dev
    - libosmesa6-dev
    - libssl-dev
    - libxmu-dev
    - libxmu6
    - python-pip
    - python-virtualenv
    - xorg-dev
    # for Android:
    - ant
    - expect
    - lib32gcc1
    - lib32stdc++6
    - lib32z1
    - openjdk-7-jdk

cache:
  directories:
    - .cargo
    - .servo
    - $HOME/.ccache

env:
  global:
  - CCACHE=/usr/bin/ccache
  - secure: "Bd4DVfGB4wWpR9ar0t0/9jMASvphpftvPMJ655zi3ai7xLpmlmC45k8olVI6LWPB0nJEb0cd95cvpMhI9L1IKV5Ojfd+nmY4bcYg4wF209iXgCmT1wmTSF2x3hmyXE1sFjjXglQc8YVN/Omb44S6TS5wx9YSGO51u8XWvyHgSAvpEvjbBH8ZzocMXg/djAMljoaT7Fu/S96B5yDEi2THqAECCbWWUvt0iAw6HyDw0f8Ug+23Mv0/Tb/kKBZcfU/muSecoJabb1xD4JSt3FAwA8s/6GDGTjIsQuxD5HwHQ6xAu7uuSr3NuuQIpDQGBO8dZECi4HqqpmPeI5ihlmrqVseiGntWkhR1ANCgVmEvR2IAVaneQKuCM//lwmGM3gj6ui5f+3j+uEz/mYyQIn5GutLPGByw2xVqD0fi9x7ON7+i5bdU3f9PJ60uTu9/Y6X9U9IYVREJ9SliyFNziotJMvxqLbWc2Xzn/bBHa93UG8olepbmzomOHZmD+XgOxp0YZDIMv8OQnacpNah4oN1jjRKsveVkr4uF2Ov6Pccts1Tvac6KqcTSbZV1vH2+2q9F6Kp56SKF+RtSelogeq2nREwSXcL4I0HnBiUujp65X7Tmm5DEfruD8OEEdA2AQhr2mKmtExxKwDA5VkX9feZACGqpl511syymrZR7+dr4B9E="

matrix:
  include:
  # Source only
  - env:
    - BUILD_TARGET=source
    script:
    - git clone https://github.com/servo/servo --depth=1
    - export ASSET_NAME=servo_source_$(date '+%Y-%m-%d').tgz
    - tar czf $ASSET_NAME servo --exclude-vcs --exclude='tests'
    - mv $ASSET_NAME servo/
    after_success:
    - ./upload_to_github.py

  # x86_64
  - env:
    - BUILD_TARGET=x86_64-unknown-linux-gnu TRIPLET=x86_64-linux-gnu

  # ARM
  - env:
    - BUILD_TARGET=arm-unknown-linux-gnueabihf TRIPLET=arm-linux-gnueabihf
    - PKG_CONFIG_ALLOW_CROSS=1 PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
    - EXPAT_NO_PKG_CONFIG=1 FREETYPE2_NO_PKG_CONFIG=1 FONTCONFIG_NO_PKG_CONFIG=1
    before_script:
    - mkdir $HOME/bin
    - for f in /usr/bin/arm-linux-*; do f2=$(basename $f); ln -s $f $HOME/bin/${f2/-linux/-unknown-linux}; done
    # download and link system libs
    - wget https://servo-rust.s3.amazonaws.com/ARM/armhf-trusty-libs.tgz
    - mkdir rootfs-trusty-armhf
    - tar xzf armhf-trusty-libs.tgz -C rootfs-trusty-armhf
    - sudo ln -s $(pwd)/rootfs-trusty-armhf/usr/include/arm-linux-gnueabihf /usr/include/arm-linux-gnueabihf
    - sudo ln -s $(pwd)/rootfs-trusty-armhf/usr/lib/arm-linux-gnueabihf /usr/lib/arm-linux-gnueabihf
    - sudo ln -s $(pwd)/rootfs-trusty-armhf/lib/arm-linux-gnueabihf /lib/arm-linux-gnueabihf

  # AArch64
  - env:
    - BUILD_TARGET=aarch64-unknown-linux-gnu TRIPLET=aarch64-linux-gnu
    - PKG_CONFIG_ALLOW_CROSS=1 PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
    - EXPAT_NO_PKG_CONFIG=1 FREETYPE2_NO_PKG_CONFIG=1 FONTCONFIG_NO_PKG_CONFIG=1
    before_script:
    - mkdir $HOME/bin
    - for f in /usr/bin/aarch64-linux-*; do f2=$(basename $f); ln -s $f $HOME/bin/${f2/-linux/-unknown-linux}; done
    # download and link system libs
    - wget https://servo-rust.s3.amazonaws.com/ARM/arm64-trusty-libs.tgz
    - mkdir rootfs-trusty-arm64
    - tar xzf arm64-trusty-libs.tgz -C rootfs-trusty-arm64
    - sudo ln -s $(pwd)/rootfs-trusty-arm64/usr/include/aarch64-linux-gnu /usr/include/aarch64-linux-gnu
    - sudo ln -s $(pwd)/rootfs-trusty-arm64/usr/lib/aarch64-linux-gnu /usr/lib/aarch64-linux-gnu
    - sudo ln -s $(pwd)/rootfs-trusty-arm64/lib/aarch64-linux-gnu /lib/aarch64-linux-gnu
    # note: do not try this at home, see servo/servo#9579
    - sudo rm /usr/bin/ld.gold

  # Android
  - env:
    - BUILD_TARGET=android TRIPLET=arm-linux-androideabi
    before_script:
    - source setup_android.sh
    script:
    - git clone https://github.com/servo/servo --depth=1
    - cd servo
    - ./mach build --rel --android

script:
  - export CC=$TRIPLET-gcc
  - export CXX=$TRIPLET-g++
  - export PATH="$PATH:$HOME/bin"
  - git clone https://github.com/servo/servo --depth=10
  - sed -i "s/stdlibs = \[host_triple(), \"arm-linux-androideabi\"\]/stdlibs = set(\[host_triple(), \"arm-linux-androideabi\", \"$BUILD_TARGET\"\])/" servo/python/servo/bootstrap_commands.py
  - cd servo
  - ./mach build --rel --target=$BUILD_TARGET

after_success:
  - cd $TRAVIS_BUILD_DIR/servo
  - export ASSET_NAME=servo_${TRIPLET}_$(date '+%Y-%m-%d').tgz
  - if [[ "$BUILD_TARGET" == "android" ]]; then ./mach package --release; fi
  - if [[ "$BUILD_TARGET" == "android" ]]; then tar czf $ASSET_NAME --transform 's|target/'$TRIPLET'/release/||' target/$TRIPLET/release/servo.apk resources; fi
  - if [[ "$BUILD_TARGET" != "android" ]]; then tar czf $ASSET_NAME --transform 's|target/'$BUILD_TARGET'/release/||' target/$BUILD_TARGET/release/servo target/$BUILD_TARGET/release/libservo.rlib resources; fi
  - cd ..
  - ./upload_to_github.py
