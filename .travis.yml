language: python

sudo: required
dist: trusty

addons:
  apt:
    packages:
    - cmake
    - curl
    - freeglut3-dev
    - g++
    - g++-aarch64-linux-gnu
    - g++-arm-linux-gnueabihf
    - gperf
    - libbz2-dev
    - libegl1-mesa-dev
    - libfreetype6-dev
    - libgl1-mesa-dri
    - libgles2-mesa-dev
    - libglib2.0-dev
    - libglu1-mesa-dev
    - libosmesa6-dev
    - libssl-dev
    - libxmu-dev
    - libxmu6
    - python-pip
    - python-virtualenv
    - xorg-dev
    # for Android:
    - ant
    - expect
    - lib32gcc1
    - lib32stdc++6
    - lib32z1
    - openjdk-7-jdk

cache:
  directories:
    - .cargo
    - .servo
    - $HOME/.ccache

env:
  global:
  - CCACHE=/usr/bin/ccache
  - secure: "Tjy1B+BeUpmuHqwmPYLKYqQuvKiAhXG5/gn7vsov+C1ieo66bBb44M14r1IRtrY+ygVz71Tn820iybUSo53/+5qmLMPtFOCwZRjnE4DYB/9Ul3+wd569w9n3vncbPl4hdhvi53ABhF8yB4TW/RIrNFd3bZQjoH0oCaS8Q+cwbbbo60/C7fOCc6DoVqw+8EjjH6/Eykqef3puRvPSJU8xiCDEtjnQRHLypXYYlcitltipPDr6MFl9+YgcT3wW9Aj2DDCfMl/hp8XzTBcrGq5WSqke8NGzm5zag8RGV8HMgzymqDr/XdU3SBFzo5F6bl501LFvu0zx17Mc7YyTcANmmGArWAFS+0JzjGyQrd3FErDnmlvtk5l3kFtEmP1E+E3a+LXD6PXbHoQyixXHXo/K1DqULImVEyWWGnsCx/3thaZtiPITwXChCSMI8bZntGyjVvcj8vqeWNTOYeOWPLWKZaMHN9/0Lw1d0DTQuGiSUwFBj9p+rfzIRsUc/1RIOf1vueaHt3K1L9wVuLdAEkatxXQWQmayniKH57M7UUAfFiNeF/Ql+q7vzBtm9U+3NmJkwEhFcxrnEta95gStB33PnSn1VGbbU/yIvnJgH9gib35r28qGOX63ySqJSsC56y1K2Tb/zHQmMjF8SLsl+1Hc3oHdX215nfkZ+BMvUZ8IuPY="
  matrix:
  - BUILD_TARGET=x86_64-unknown-linux-gnu TRIPLET=x86_64-linux-gnu
  - BUILD_TARGET=arm-unknown-linux-gnueabihf TRIPLET=arm-linux-gnueabihf PKG_CONFIG_ALLOW_CROSS=1 PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
  - BUILD_TARGET=aarch64-unknown-linux-gnu TRIPLET=aarch64-linux-gnu PKG_CONFIG_ALLOW_CROSS=1 PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
  - BUILD_TARGET=arm-linux-androideabi TRIPLET=arm-linux-androideabi

matrix:
  include:
  - before_script:
    - git clone https://github.com/servo/servo --depth=1
    script:
    - export ASSET_NAME=servo_source_$(date '+%Y-%m-%d').tgz
    - tar czf $ASSET_NAME servo --exclude-vcs --exclude='tests'
    - mv $ASSET_NAME servo/
    after_success:
    - ./upload_to_github.py

before_script:
  - mkdir $HOME/bin
  - for f in /usr/bin/arm-linux-*; do f2=$(basename $f); ln -s $f $HOME/bin/${f2/-linux/-unknown-linux}; done
  - for f in /usr/bin/aarch64-linux-*; do f2=$(basename $f); ln -s $f $HOME/bin/${f2/-linux/-unknown-linux}; done
  - PATH="$PATH:$HOME/bin"
  - git clone https://github.com/servo/servo --depth=10
  - sed -i "s/stdlibs = \[host_triple(), \"arm-linux-androideabi\"\]/stdlibs = set(\[host_triple(), \"arm-linux-androideabi\", \"$BUILD_TARGET\"\])/" servo/python/servo/bootstrap_commands.py
  - if [[ "$BUILD_TARGET" == "arm-linux-androideabi" ]]; then source setup_android.sh; fi

script:
  - cd servo
  - ./mach build --rel --target=$BUILD_TARGET

after_success:
  - cd $TRAVIS_BUILD_DIR/servo
  - export ASSET_NAME=servo_$TRIPLET_$(date '+%Y-%m-%d').tgz
  - if [[ "$BUILD_TARGET" == "arm-linux-androideabi" ]]; then ./mach package --release; fi
  - if [[ "$BUILD_TARGET" == "arm-linux-androideabi" ]]; then tar czf $ASSET_NAME --transform 's|target/'$BUILD_TARGET'/release/||' target/$BUILD_TARGET/release/servo.apk resources; fi
  - if [[ "$BUILD_TARGET" != "arm-linux-androideabi" ]]; then tar czf $ASSET_NAME --transform 's|target/'$BUILD_TARGET'/release/||' target/$BUILD_TARGET/release/servo target/$BUILD_TARGET/release/libservo.rlib resources; fi
  - cd ..
  - ./upload_to_github.py
